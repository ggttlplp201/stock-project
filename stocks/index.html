<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Stock & Crypto Viewer</title>
  <style>
    :root { --bg:#f5f7fa; --card:#fff; --txt:#222; --muted:#666; --brand:#0077ff; --brand-d:#005fcc; }
    * { box-sizing: border-box; }
    body { margin:0; padding:2rem; font-family:Arial, sans-serif; background:var(--bg); display:flex; justify-content:center; }
    .container { width:100%; max-width:1100px; }
    h1 { text-align:center; color:var(--txt); margin:0 0 .25rem; }
    .sub { text-align:center; color:var(--muted); margin-bottom:1.25rem; }

    .tabs { display:flex; gap:8px; justify-content:center; margin: 1rem 0 1.25rem; }
    .tab-btn { padding:.6rem 1rem; border:1px solid #cfd6e4; background:#e9eef6; color:#24324a; border-radius:8px; cursor:pointer; }
    .tab-btn.active { background:var(--brand); color:#fff; border-color:var(--brand); }

    .rec-wrap { margin-bottom: 1.25rem; }
    .rec-header { display:flex; justify-content:space-between; margin-bottom:.5rem; }
    .rec-title { font-weight:700; }
    .rec-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(220px,1fr)); gap:12px; }
    .rec-card { background:var(--card); border-radius:10px; padding:12px; box-shadow:0 6px 18px rgba(0,0,0,.08); cursor:pointer; transition:.2s; }
    .rec-card:hover { transform:translateY(-2px); box-shadow:0 10px 22px rgba(0,0,0,.12); }
    .rec-symbol { font-weight:700; }
    .rec-reason { margin-top:8px; font-size:.95rem; color:#333; }

    .form-row { display:flex; gap:10px; margin-bottom:1rem; justify-content:center; flex-wrap:wrap; }
    input, select { padding:10px; font-size:1rem; border:1px solid #ccc; border-radius:8px; }
    .btn { padding:10px 16px; font-size:1rem; border:0; border-radius:8px; background:var(--brand); color:#fff; cursor:pointer; }
    .btn:hover { background:var(--brand-d); }
    .hint { text-align:center; color:var(--muted); margin-bottom: 1rem; }

    .card { background:var(--card); padding:1.2rem; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.08); margin-bottom:1.25rem; }
    .card h2 { margin:0 0 .5rem; }
    .error { color:#c62828; font-weight:700; }

    .tv-wrap { background:var(--card); border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.08); padding:1rem; }
    .tv-container { width:100%; height:600px; }

    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“ˆ Stock & Crypto Viewer</h1>
    <p class="sub">å¼€é¡µå³çœ‹ AI æ¨èï¼ˆè‚¡ç¥¨ï¼‰ â€¢ æŸ¥è¯¢æŠ¥ä»·ä¸å›¾è¡¨ï¼ˆè‚¡ç¥¨/åŠ å¯†ï¼‰â€¢ ä»…å­¦ä¹ æ¼”ç¤ºï¼ŒéæŠ•èµ„å»ºè®®</p>

    <div class="tabs">
      <button id="tab-stocks" class="tab-btn active">Stocks</button>
      <button id="tab-crypto" class="tab-btn">Crypto</button>
    </div>

    <!-- Stocks -->
    <section id="panel-stocks">
      <div class="rec-wrap">
        <div class="rec-header">
          <div class="rec-title">AI æ¨èè‚¡ç¥¨</div>
          <div id="rec-status" class="rec-hint">æ­£åœ¨ç”Ÿæˆæ¨èâ€¦</div>
        </div>
        <div id="rec-grid" class="rec-grid"></div>
      </div>

      <form id="stock-form" class="form-row">
        <input type="text" id="symbol" required placeholder="e.g. AAPL æˆ– TSLA" />
        <button class="btn" type="submit">Get Quote</button>
      </form>
      <div class="hint">è¾“å…¥ä»£ç ï¼ˆ<code>AAPL</code>ã€<code>TSLA</code> ç­‰ï¼‰ã€‚</div>

      <div id="result" class="card"></div>
    </section>

    <!-- Crypto -->
    <section id="panel-crypto" class="hidden">
      <form id="crypto-form" class="form-row">
        <input type="text" id="cryptoSymbol" required placeholder="å¸ç§ï¼ˆå¦‚ï¼šBTCã€ETHï¼‰" />
        <select id="cryptoMarket">
          <option value="USD" selected>USDï¼ˆç¾å…ƒï¼‰</option>
          <option value="USDT">USDTï¼ˆæ³°è¾¾ï¼‰</option>
          <option value="EUR">EURï¼ˆæ¬§å…ƒï¼‰</option>
          <option value="JPY">JPYï¼ˆæ—¥å…ƒï¼‰</option>
        </select>
        <select id="cryptoExchange">
          <option value="COINBASE" selected>Coinbaseï¼ˆUSDï¼‰</option>
          <option value="BINANCE">Binanceï¼ˆUSDTï¼‰</option>
        </select>
        <button class="btn" type="submit">Get Crypto</button>
      </form>
      <div class="hint">å®æ—¶æ±‡ç‡æ¥è‡ª Alpha Vantageï¼›å›¾è¡¨åŸºäºæ‰€é€‰äº¤æ˜“æ‰€ï¼ˆCoinbase=USDã€Binance=USDTï¼‰ã€‚</div>

      <div id="crypto-result" class="card"></div>
    </section>

    <!-- Chart -->
    <div class="tv-wrap">
      <h2 id="chart-title" style="margin:0 0 .5rem;">Interactive Chart</h2>
      <div id="tv_chart_container" class="tv-container"></div>
    </div>
  </div>

  <!-- TradingView -->
  <script src="https://s3.tradingview.com/tv.js"></script>
  <script>
    /* ========= Config ========= */
    const AV_API_KEY = 'MXW8J9FLMSVW8FAW';        // Alpha Vantage
    const PROXY_URL = "/api/chat";                 // âœ… ç”¨ Vercel ä»£ç†ï¼›ä¸è¦åœ¨å‰ç«¯æ”¾ OpenAI Key
    const OPENAI_MODEL = 'gpt-4o-mini';
    // å¦‚æœä½ ç»™ä»£ç†åŠ äº†é‰´æƒï¼Œå¯è§£å¼€ä¸‹ä¸€è¡Œå¹¶åœ¨è¯·æ±‚å¤´é‡ŒåŠ  x-proxy-key
    // const PROXY_ACCESS_KEY = "ä½ çš„è‡ªå®šä¹‰å‰ç«¯è®¿é—®é”®";

    /* ========= DOM ========= */
    const tabStocks = document.getElementById('tab-stocks');
    const tabCrypto = document.getElementById('tab-crypto');
    const panelStocks = document.getElementById('panel-stocks');
    const panelCrypto = document.getElementById('panel-crypto');
    const chartTitle = document.getElementById('chart-title');

    const stockForm = document.getElementById('stock-form');
    const resultDiv = document.getElementById('result');
    const recGrid = document.getElementById('rec-grid');
    const recStatus = document.getElementById('rec-status');

    const cryptoForm = document.getElementById('crypto-form');
    const cryptoResult = document.getElementById('crypto-result');

    /* ========= Tabs ========= */
    function setActiveTab(which){
      if(which==='stocks'){
        tabStocks.classList.add('active'); tabCrypto.classList.remove('active');
        panelStocks.classList.remove('hidden'); panelCrypto.classList.add('hidden');
      } else {
        tabCrypto.classList.add('active'); tabStocks.classList.remove('active');
        panelCrypto.classList.remove('hidden'); panelStocks.classList.add('hidden');
      }
    }
    tabStocks.addEventListener('click', ()=>setActiveTab('stocks'));
    tabCrypto.addEventListener('click', ()=>setActiveTab('crypto'));

    /* ========= TradingView ========= */
    function renderTradingView(symbolLike){
      const container = document.getElementById('tv_chart_container');
      container.innerHTML = '';
      if (typeof TradingView === 'undefined' || !TradingView.widget) {
        container.innerHTML = '<div class="error">TradingView è„šæœ¬æœªåŠ è½½æˆåŠŸã€‚</div>';
        return;
      }
      new TradingView.widget({
        autosize: true,
        symbol: symbolLike,
        interval: "D",
        timezone: "Etc/UTC",
        theme: "light",
        style: "1",
        locale: "en",
        toolbar_bg: "#f1f3f6",
        enable_publishing: false,
        allow_symbol_change: true,
        container_id: "tv_chart_container"
      });
    }

    /* ========= Alpha Vantageï¼šStocks ========= */
    async function fetchQuote(symbol) {
      const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${encodeURIComponent(symbol)}&apikey=${AV_API_KEY}`;
      const res = await fetch(url);
      const data = await res.json();
      return data && data['Global Quote'] && data['Global Quote']['01. symbol'] ? data['Global Quote'] : null;
    }
    function renderQuote(quote) {
      resultDiv.innerHTML = `
        <h2>${quote['01. symbol']}</h2>
        <p><strong>Price:</strong> $${quote['05. price']}</p>
        <p><strong>Open:</strong> $${quote['02. open']}</p>
        <p><strong>High:</strong> $${quote['03. high']}</p>
        <p><strong>Low:</strong> $${quote['04. low']}</p>
        <p><strong>Prev Close:</strong> $${quote['08. previous close']}</p>
        <p><strong>Change:</strong> ${quote['09. change']} (${quote['10. change percent']})</p>
      `;
    }

    /* ========= Alpha Vantageï¼šCrypto ========= */
    async function fetchCryptoExchangeRate(base, quote){
      const url = `https://www.alphavantage.co/query?function=CURRENCY_EXCHANGE_RATE&from_currency=${encodeURIComponent(base)}&to_currency=${encodeURIComponent(quote)}&apikey=${AV_API_KEY}`;
      const res = await fetch(url);
      const data = await res.json();
      return data && data['Realtime Currency Exchange Rate'] ? data['Realtime Currency Exchange Rate'] : null;
    }
    async function fetchCryptoDaily(base, quote){
      const url = `https://www.alphavantage.co/query?function=DIGITAL_CURRENCY_DAILY&symbol=${encodeURIComponent(base)}&market=${encodeURIComponent(quote)}&apikey=${AV_API_KEY}`;
      const res = await fetch(url);
      const data = await res.json();
      return data && data['Time Series (Digital Currency Daily)'] ? data['Time Series (Digital Currency Daily)'] : null;
    }
    function renderCryptoQuote(base, quote, exRate, dailySeries){
      let ohlcHtml = '';
      if (dailySeries){
        const dates = Object.keys(dailySeries).sort().reverse();
        if (dates.length){
          const d0 = dailySeries[dates[0]];
          const open = d0['1a. open (USD)'] || d0['1b. open (USD)'] || d0['1a. open ('+quote+')'];
          const high = d0['2a. high (USD)'] || d0['2b. high (USD)'] || d0['2a. high ('+quote+')'];
          const low  = d0['3a. low (USD)']  || d0['3b. low (USD)']  || d0['3a. low ('+quote+')'];
          const close= d0['4a. close (USD)']|| d0['4b. close (USD)']|| d0['4a. close ('+quote+')'];
          ohlcHtml = `<p><strong>Daily (last):</strong> O ${open} â€¢ H ${high} â€¢ L ${low} â€¢ C ${close} (${dates[0]})</p>`;
        }
      }
      const p = exRate ? exRate['5. Exchange Rate'] : 'â€”';
      const t = exRate ? exRate['6. Last Refreshed'] : 'â€”';
      const bid = exRate ? exRate['8. Bid Price'] : 'â€”';
      const ask = exRate ? exRate['9. Ask Price'] : 'â€”';

      cryptoResult.innerHTML = `
        <h2>${base}/${quote}</h2>
        <p><strong>Real-time:</strong> ${p} (${t})</p>
        <p><strong>Bid/Ask:</strong> ${bid} / ${ask}</p>
        ${ohlcHtml}
      `;
    }

    /* ========= Stocksï¼šAI æ¨èï¼ˆé€šè¿‡ä»£ç†ï¼‰ ========= */
    const UNIVERSE = ["AAPL","MSFT","NVDA","AMZN","GOOGL","META","TSLA","V","MA","JPM","HD","UNH"];

    async function getAIRecommendations(n=4){
      const prompt = `
ä»ä»¥ä¸‹è‚¡ç¥¨æ± ä¸­æŒ‘é€‰${n}åªå€¼å¾—å…³æ³¨çš„è‚¡ç¥¨ï¼Œå¹¶ç»™å‡ºä¸€å¥ç®€çŸ­ç†ç”±ï¼ˆä¸­æ–‡ï¼ŒéæŠ•èµ„å»ºè®®ï¼‰:
${UNIVERSE.join(", ")}
æ ¼å¼: JSONæ•°ç»„ [{ "symbol":"AAPL", "reason":"ç†ç”±" }]
      `;
      try {
        const resp = await fetch(PROXY_URL, {
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            // å¦‚æœåç«¯åŠ äº†é‰´æƒï¼Œè§£å¼€ä¸‹ä¸€è¡Œå¹¶è®¾ç½®åŒæ ·çš„å€¼
            // "x-proxy-key": PROXY_ACCESS_KEY,
          },
          body: JSON.stringify({
            model: OPENAI_MODEL,
            messages: [{ role: "user", content: prompt }],
            temperature: 0.7
          })
        });
        const json = await resp.json();
        return JSON.parse(json?.choices?.[0]?.message?.content || "[]");
      } catch (e) {
        console.error("AI proxy error:", e);
        return [];
      }
    }

    function renderRecommendations(list){
      recGrid.innerHTML="";
      list.forEach(item=>{
        const card=document.createElement("div");
        card.className="rec-card";
        card.innerHTML=`<div class="rec-symbol">${item.symbol}</div><div class="rec-reason">${item.reason||""}</div>`;
        card.addEventListener("click", async ()=>{
          const symbol=item.symbol.toUpperCase();
          document.getElementById('symbol').value=symbol;
          resultDiv.textContent="Loading...";
          const quote=await fetchQuote(symbol);
          if(quote){ renderQuote(quote); chartTitle.textContent = `${symbol} â€¢ Stock Chart`; renderTradingView(symbol); }
          else { resultDiv.innerHTML = `<span class="error">No data for ${symbol}</span>`; }
          window.scrollTo({top:document.querySelector('.tv-wrap').offsetTop-16,behavior:'smooth'});
        });
        recGrid.appendChild(card);
      });
    }

    /* ========= Init ========= */
    document.addEventListener('DOMContentLoaded', async ()=>{
      chartTitle.textContent = 'AAPL â€¢ Stock Chart';
      renderTradingView("AAPL");

      try{
        let recs = await getAIRecommendations(4);
        if(recs.length){
          renderRecommendations(recs);
          recStatus.textContent="å·²åŠ è½½æ¨èï¼ˆAI ç”Ÿæˆï¼‰";
        } else {
          recStatus.textContent="å·²åŠ è½½æ¨èï¼ˆæœ¬åœ°å…œåº•ï¼‰";
          renderRecommendations(UNIVERSE.slice(0,4).map(s=>({symbol:s,reason:"å¸‚åœºå…³æ³¨åº¦é«˜"})));
        }
      }catch{
        recStatus.textContent="AI æ¨èä¸å¯ç”¨";
      }
    });

    /* ========= Events ========= */
    stockForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const symbol=document.getElementById('symbol').value.trim().toUpperCase();
      if(!symbol) return;
      resultDiv.textContent="Loading...";
      const quote=await fetchQuote(symbol);
      if(quote){
        renderQuote(quote);
        chartTitle.textContent = `${symbol} â€¢ Stock Chart`;
        renderTradingView(symbol);
      } else {
        resultDiv.innerHTML = `<span class="error">No data for ${symbol}</span>`;
      }
    });

    cryptoForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const base = document.getElementById('cryptoSymbol').value.trim().toUpperCase();
      let quote = document.getElementById('cryptoMarket').value.trim().toUpperCase();
      const exSel = document.getElementById('cryptoExchange').value;
      if(!base || !quote) return;

      cryptoResult.textContent = 'Loading...';

      try {
        const exRate = await fetchCryptoExchangeRate(base, quote);
        const daily = await fetchCryptoDaily(base, quote);
        renderCryptoQuote(base, quote, exRate, daily);

        let tvSymbol = '';
        if (exSel === 'COINBASE') {
          const q = (quote === 'USDT') ? 'USD' : quote;
          tvSymbol = `COINBASE:${base}${q}`;
        } else {
          const q = (quote === 'USD') ? 'USDT' : quote;
          tvSymbol = `BINANCE:${base}${q}`;
        }
        chartTitle.textContent = `${base}/${quote} â€¢ Crypto Chart`;
        renderTradingView(tvSymbol);
      } catch(err){
        console.error(err);
        cryptoResult.innerHTML = `<span class="error">Error fetching crypto data.</span>`;
      }
    });
  </script>
</body>
</html>
